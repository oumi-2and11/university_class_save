#include <iostream>
#include <string>
using namespace std;
int get(int r);
void yihuo(int* a, int* b, int num);
void left_move(int s[56], int n);
void exchange(int* a, int* b, int* biao, int n);
void shizhuaner(int* a, int x, int i, int n);
void s_box(int a[32], int b[48]);
void round(int r, int a[56], int b[48], int r_a[32], int r_b[48], int l[32]);

int get(int r)         //得到第r轮的移位数 
{
	int i;
	if (r == 1 || r == 2 || r == 9 || r == 16) i = 1;
	else i = 2;
	return i;
}

void yihuo(int* a, int* b, int num)      //异或 
{
	int i;
	for (i = 0; i < num; i++)
	{
		if (a[i] == b[i])  a[i] = 0;
		else
			a[i] = 1;
	}
}

void left_move(int s[56], int n)         //左移 
{
	int i;
	for (i = 0; i <= 28 - n; i++)
	{
		s[i] = s[(i + n) % 28];
	}
	for (i = 28; i <= 56 - n; i++)
	{
		s[i] = s[(i + n) % 56];
	}
}

void exchange(int* a, int* b, int* biao, int n)    //置换 
{
	int i, loc;
	for (i = 0; i < n; i++)
	{
		loc = biao[i];
		b[i] = a[loc - 1];
	}
	return;
}


void shizhuaner(int* a, int x, int i, int n)
// a是存放二进制的数组，x是需要进行转换的十进制数，i是第i个十进制数，n是数组大小
{
	int j; n = n / 8; j = n - 1;
	do {
		a[i * n + j] = x % 2;
		x = x / 2;
		j--;
	} while (x != 0);
	while (j >= 0)
	{
		a[i * n + j] = 0;
		j--;
	}
	return;
}


void s_box(int a[32], int b[48])         //S盒
{
	int i, r, c, s;
	//a[0] = b[1]; a[1] = b[2]; a[2] = b[3]; a[3] = b[4]; 
	//a[4] = b[7]; a[5] = b[8];a[6] = b[9]; a[7] = b[10];
	//a[8] = b[13]; a[9] = b[14]; a[10] = b[15]; a[11] = b[16];
	//a[12] = b[19]; a[13] = b[20];a[14] = b[21];a[15] = b[22];
	//a[16] = b[25]; a[17] = b[26];a[18] = b[27];a[19] = b[28];
	//a[20] = b[31]; a[21] = b[32];a[22] = b[33];a[23] = b[34];
	//a[24] = b[37]; a[25] = b[38];a[26] = b[39];a[27] = b[40];
	//a[28] = b[43]; a[29] = b[44];a[30] = b[45];a[31] = b[46];

	int s1[4][16] = { { 14, 4, 13, 1, 2, 15, 11, 8, 3, 10, 6, 12, 5, 9, 0, 7 },{ 0, 15, 7, 4, 14, 2, 13, 1, 10, 6, 12, 11, 9, 5, 3, 8 },{ 4, 1, 14, 8, 13, 6, 2, 11, 15, 12, 9, 7, 3, 10, 5, 0 },{ 15, 12, 8, 2, 4, 9, 1, 7, 5, 11, 3, 14, 10, 0, 6, 13 } },
		s2[4][16] = { { 15, 1, 8, 14, 6, 11, 3, 4, 9, 7, 2, 13, 12, 0, 5, 10 },{ 3, 13, 4, 7, 15, 2, 8, 14, 12, 0, 1, 10, 6, 9, 11, 5 },{ 0, 14, 7, 11, 10, 4, 13, 1, 5, 8, 12, 6, 9, 3, 2, 15 },{ 13, 8, 10, 1, 3, 15, 4, 2, 11, 6, 7, 12, 0, 5, 14, 9 } },
		s3[4][16] = { { 10, 0, 9, 14, 6, 3, 15, 5, 1, 13, 12, 7, 11, 4, 2, 8 },{ 13, 7, 0, 9, 3, 4, 6, 10, 2, 8, 5, 14, 12, 11, 15, 1 },{ 13, 6, 4, 9, 8, 15, 3, 0, 11, 1, 2, 12, 5, 10, 14, 7 },{ 1, 10, 13, 0, 6, 9, 8, 7, 4, 15, 14, 3, 11, 5, 2, 12 } },
		s4[4][16] = { { 7, 13, 14, 3, 0, 6, 9, 10, 1, 2, 8, 5, 11, 12, 4, 15 },{ 13, 8, 11, 5, 6, 15, 0, 3, 4, 7, 2, 12, 1, 10, 14, 9 },{ 10, 6, 9, 0, 12, 11, 7, 13, 15, 1, 3, 14, 5, 2, 8, 3 },{ 3, 15, 0, 6, 10, 1, 13, 8, 9, 4, 5, 11, 12, 7, 2, 14 } },
		s5[4][16] = { { 2, 12, 4, 1, 7, 10, 11, 6, 8, 5, 3, 15, 13, 0, 14, 9 },{ 14, 11, 2, 12, 4, 7, 13, 1, 5, 0, 15, 10, 3, 9, 8, 6 },{ 4, 2, 1, 11, 10, 13, 7, 8, 15, 9, 12, 5, 6, 3, 0, 14 },{ 11, 8, 12, 7, 1, 14, 2, 13, 6, 15, 0, 9, 10, 4, 5, 3 } },
		s6[4][16] = { { 12, 1, 10, 15, 9, 2, 6, 8, 0, 13, 3, 4, 14, 7, 5, 11 },{ 10, 15, 4, 2, 7, 12, 9, 5, 6, 1, 13, 14, 0, 11, 3, 8 },{ 9, 14, 15, 5, 2, 8, 12, 3, 7, 0, 4, 10, 1, 13, 11, 6 },{ 4, 3, 2, 12, 9, 5, 15, 10, 11, 14, 1, 7, 6, 0, 8, 13 } },
		s7[4][16] = { { 4, 11, 2, 14, 15, 0, 8, 13, 3, 12, 9, 7, 5, 10, 6, 1 },{ 13, 0, 11, 7, 4, 9, 1, 10, 14, 3, 5, 12, 2, 15, 8, 6 },{ 1, 4, 11, 13, 12, 3, 7, 14, 10, 15, 6, 8, 0, 5, 9, 2 },{ 6, 11, 13, 8, 1, 4, 10, 7, 9, 5, 0, 15, 14, 2, 3, 12 } },
		s8[4][16] = { { 13, 2, 8, 4, 6, 15, 11, 1, 10, 9, 3, 14, 5, 0, 12, 7 },{ 1, 15, 13, 8, 10, 3, 7, 4, 12, 5, 6, 11, 0, 14, 9, 2 },{ 7, 11, 4, 1, 9, 12, 14, 2, 0, 6, 10, 13, 15, 3, 5, 8 },{ 2, 1, 14, 7, 4, 10, 8, 13, 15, 12, 9, 0, 3, 5, 6, 11 } };
	for (i = 0; i < 8; i++)
	{
		r = 2 * b[6 * i] + b[6 * i + 5];
		c = 8 * b[6 * i + 1] + 4 * b[6 * i + 2] + 2 * b[6 * i + 3] + b[6 * i + 4];
		switch (i)
		{
		case 0:s = s1[r][c]; break;
		case 1:s = s2[r][c]; break;
		case 2:s = s3[r][c]; break;
		case 3:s = s4[r][c]; break;
		case 4:s = s5[r][c]; break;
		case 5:s = s6[r][c]; break;
		case 6:s = s7[r][c]; break;
		case 7:s = s8[r][c]; break;
		}
		shizhuaner(a, s, i, 32);
	}
}

void round(int r, int a[56], int b[48], int r_a[32], int r_b[48], int l[32])
{
	int i, n, r1[32], r2[32]; //r1,r2为中间数组 
	int	zhihuan2[48] = { 14, 17, 11, 24, 1, 5, 3, 28, 15, 6, 21, 10, 23, 19, 12, 4, 26, 8, 16, 7, 27, 20, 13, 2, 41, 52, 31, 37, 47, 55, 30, 40, 51, 45, 33, 48, 44, 49, 39, 56, 34, 53, 46, 42, 50, 36, 29, 32 };  //置换2 
	int	e[48] = { 32, 1, 2, 3, 4, 5,4, 5, 6, 7, 8, 9,8, 9, 10, 11, 12, 13,12, 13, 14, 15, 16, 17,16, 17, 18, 19, 20, 21,20, 21, 22, 23, 24, 25,24, 25, 26, 27, 28, 29,28, 29, 30, 31, 32, 1 };    //E盒 
	int	P[32] = { 16, 7, 20, 21, 29, 12, 28, 17, 1, 15, 23, 26, 5, 18, 31, 10, 2, 8, 24, 14, 32, 27, 3, 9, 19, 13, 30, 6, 22, 11, 4, 25 };     //P盒 
	printf("这是第%d轮密文：\n", r);
	n = get(r); left_move(a, n); exchange(a, b, zhihuan2, 48);
	cout << "PC-2置换后密钥为：" << endl;
	for (int i = 0; i < 48; i++)
	{
		cout << b[i];
	}
	cout << endl;
	exchange(r_a, r_b,e,48);//E扩展
	//删除E扩散
	/*for (int j = 0; j < 48; j++)
	{
		if (j < 32)r_b[j] = r_a[j];
		else r_b[j] = 0;
	}*/
	cout << "E扩展后Ri:" << endl;
	for (int j = 0; j < 48; j++)
	{
		cout << r_b[j];
	}
	cout << endl;
	yihuo(r_b, b, 48); 
	cout << "密钥加XOR:" << endl;
	for (int j = 0; j < 48; j++)
	{
		cout << r_b[j];
	}
	cout << endl;
	s_box(r1, r_b); 
	cout << "S盒" << endl;
	for (int j = 0; j < 32; j++)
	{
		cout << r1[j];
	}
	cout << endl;
	//exchange(r1, r2, P, 32);
	//删除P置换
	for (int j = 0; j < 32; j++)
	{
		r2[j]= r1[j];
	}
	cout << "伦函数P置换" << endl;
	for (int j = 0; j < 32; j++)
	{
		cout << r2[j];
	}
	cout << endl;
	for (i = 0; i < 32; i++)    r1[i] = r2[i];
	yihuo(r1, l, 32);
	for (i = 0; i < 32; i++)    l[i] = r_a[i];  //准备下次循环的L
	for (i = 0; i < 32; i++)    r_a[i] = r1[i];  //准备下次循环的R
	for (i = 0; i < 32; i++)     cout << l[i];//printf("%c ", mi_l[i]);  //第r轮L部分的密文
	cout << " ";
	for (i = 0; i < 32; i++)    cout << r_a[i];//printf("%c ", mi_r[i]);  //第r轮R部分的密文
	printf("\n\n");
	return;
}

int main()
{
	int m_a[64], m_b[64];          //IP置换前后的明文 
	int s_a[64], s_b[56];          //置换1前后的二进制密钥 
	int r;            //轮数
	int s_c[48];      //置换2后的数组
	int r_a[32]={0}, r_b[48] = {0};          //E扩展前后的m_b的右半部分明文
	int l[32];        //m_b的左半部分
	//char mi_r[8], mi_l[8];         //存储密文的十六进制
	int mi1[64], mi2[64];          //IP_1置换前后的密文 
	//char miwen[16];   //最终密文 
	int i;

	int zhihuan1[56] = { 57, 49, 41, 33, 25, 17, 9, 1, 58, 50, 42, 34, 26, 18, 10, 2, 59, 51, 43, 35, 27, 19, 11, 3, 60, 52, 44, 36, 63, 55, 47, 39, 31, 23, 15, 7, 62, 54, 46, 38, 30, 22, 14, 6, 61, 53, 45, 37, 29, 21, 13, 5, 28, 20, 12, 4 };      //置换1 
	int IP[64] = { 58, 50, 42, 34, 26, 18, 10, 2, 60, 52, 44, 36, 28, 20, 12, 4, 62, 54, 46, 38, 30, 22, 14, 6, 64, 56, 48, 40, 32, 24, 16, 8, 57, 49, 41, 33, 25, 17, 9, 1, 59, 51, 43, 35, 27, 19, 11, 3, 61, 53, 45, 37, 29, 21, 13, 5, 63, 55, 47, 39, 31, 23, 15, 7 };    //IP置换 
	int IP_1[64] = { 40, 8, 48, 16, 56, 24, 64, 32, 39, 7, 47, 15, 55, 23, 63, 31, 38, 6, 46, 14, 54, 22, 62, 30, 37, 5, 45, 13, 53, 21, 61, 29, 36, 4, 44, 12, 52, 20, 60, 28, 35, 3, 43, 11, 51, 19, 59, 27, 34, 2, 42, 10, 50, 18, 58, 26, 33, 1, 41, 9, 49, 17, 57, 25 };    //IP_1置换
	cout<<"*---------------DES加密--------------\n\n";
	string binary_input,key;
	cout << "请输入64位二进制明文（0/1）: ";
	cin >> binary_input;
	cout << "输入密钥" << endl;
	cin >> key;
	// 输入验证
	if (binary_input.length() != 64) {
		cerr << "错误：必须输入64位二进制数！" << endl;
		return 1;
	}
	for (char c : binary_input) {
		if (c != '0' && c != '1') {
			cerr << "错误：包含非二进制字符！" << endl;
			return 1;
		}
	}
	if (key.length() != 64) {
		cerr << "错误：必须输入64位二进制数！" << endl;
		return 1;
	}
	for (char c : key) {
		if (c != '0' && c != '1') {
			cerr << "错误：包含非二进制字符！" << endl;
			return 1;
		}
	}
	// 直接填充二进制数组（删除原字符转二进制逻辑）
	for (int i = 0; i < 64; i++) {
		m_a[i] = binary_input[i] - '0';
	}
	for (int i = 0; i < 64; i++) {
		s_a[i] = key[i] - '0';
	}
	exchange(m_a, m_b, IP, 64);//明文进行IP置换
	cout << "明文IP置换后：";
	for (int k = 0; k < 64; k++)
	{
		cout << m_b[k];
	}
	cout << endl;
	for (i = 0; i < 32; i++)//取明文左半部分L0
		l[i] = m_b[i];
	for (i = 32; i < 64; i++)
		r_a[i - 32] = m_b[i];//右边,R0
	//cout << "R0:";
	//for (int k = 0; k < 32; k++)
	//{
	//	cout << r_a[k];
	//}
	cout << endl;
	exchange(s_a, s_b, zhihuan1, 56);//密钥PC-1置换，s_b为置换后的密钥
	int r_ap[32] = { 1,1,0,1,0,1,1,0,1,0,1,0,0,1,0,1,0,0,1,0,0,1,0,1,1,0,0,0,1,0,0,1 };//第三题
	for (r = 1; r <= 16; r++)
		round(r, s_b, s_c, r_ap, r_b, l);//r:轮数，s_b:PC-1置换后的密钥56位。
													//s_c:PC-2置换后的密钥48位，
													//r_a:R0，r_b:r_aE扩展后分明文，l:L0

	for (i = 0; i < 64; i++)  //将密文R的部分与密文L的部分合一起
	{
		mi1[i] = r_a[i];
		if (i >= 32) mi1[i] = l[i - 32];
	}
	//cout << "逆置换前：" << endl;
	//for (i = 0; i < 64; i++)
	//{
	//	cout << mi1[i];
	//}
	//cout << endl;
	exchange(mi1, mi2, IP_1, 64);//IP逆置换
	cout<<"##########这是最终密文:##########\n";
	for (i = 0; i < 64; i++)
		cout<<mi2[i];
	cout << endl;
	return 0;
}
